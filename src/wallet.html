<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Wallet</title>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="description" content="Bluesky template project">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" type="text/css" href="styles/bootstrap4/bootstrap.min.css">
		<link href="plugins/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
		<link rel="stylesheet" type="text/css" href="plugins/rangeslider.js-2.3.0/rangeslider.css">
		<link rel="stylesheet" type="text/css" href="styles/news.css">
		<link rel="stylesheet" type="text/css" href="styles/news_responsive.css">

		<style type="text/css">
		
			.custom_button
			{
				width: 193px;
				height: 100%;
				height: 60px;
				border-radius: 35px;
				border: none;
				outline: none;
				cursor: pointer;
				font-size: 14px;
				font-weight: 700;
				color: #FFFFFF;
				text-transform: uppercase;
				background: linear-gradient(to right, #487fee, #32fa95);
				outline: none;
			}
		</style>
	</head>
	<body>

		<div class="super_container">

			<!-- Header -->
			<!-- header is to be written by js -->

			<!-- Menu -->

			<div class="menu trans_500">
				<div class="menu_content d-flex flex-column align-items-center justify-content-center text-center">
					<div class="menu_close_container"><div class="menu_close"></div></div>
					<div class="logo menu_logo">
						<a href="#">
							<div class="logo_container d-flex flex-row align-items-start justify-content-start">
								<div class="logo_image"><div><img src="images/trust_lend_logo.png" alt=""></div></div>
							</div>
						</a>
					</div>
					<ul>
						<li class="menu_item"><a href="index.html">Home</a></li>
						<li class="menu_item"><a href="borrow.html">Borrow</a></li>
						<li class="menu_item"><a href="lend.html">Lend</a></li>
						<li class="menu_item"><a href="wallet.html">My Wallet</a></li>
						<li class="menu_item"><a href="contact.html">Contact</a></li>
					</ul>
				</div>
				<div class="menu_phone"><span>call us: </span>9604 2093</div>
			</div>

			<!-- Home -->

			<div class="home" style="display: none;">
				<div class="parallax_background parallax-window" data-parallax="scroll" data-image-src="images/news.jpg" data-speed="0.8"></div>
				<div class="home_container">
					<div class="container">
						<div class="row">
							<div class="col">
								<div class="home_content d-flex flex-row align-items-end justify-content-start">
									<div class="home_title">News</div>
									<div class="breadcrumbs ml-auto">
										<ul>
											<li><a href="index.htmo">Home</a></li>
											<li>News</li>
										</ul>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Home Search -->
			<div class="home_search" style="display: none;">
				<div class="container">
					<div class="row">
						<div class="col">
							<div class="home_search_container">
								<div class="home_search_content">
									<form action="#" class="search_form d-flex flex-row align-items-start justfy-content-start">
										<div class="search_form_content d-flex flex-row align-items-start justfy-content-start flex-wrap">
											<div>
												<select class="search_form_select">
													<option disabled selected>For rent</option>
													<option>Yes</option>
													<option>No</option>
												</select>
											</div>
											<div>
												<select class="search_form_select">
													<option disabled selected>All types</option>
													<option>Type 1</option>
													<option>Type 2</option>
													<option>Type 3</option>
													<option>Type 4</option>
												</select>
											</div>
											<div>
												<select class="search_form_select">
													<option disabled selected>City</option>
													<option>New York</option>
													<option>Paris</option>
													<option>Amsterdam</option>
													<option>Rome</option>
												</select>
											</div>
											<div>
												<select class="search_form_select">
													<option disabled selected>Bedrooms</option>
													<option>1</option>
													<option>2</option>
													<option>3</option>
													<option>4</option>
												</select>
											</div>
											<div>
												<select class="search_form_select">
													<option disabled selected>Bathrooms</option>
													<option>1</option>
													<option>2</option>
													<option>3</option>
												</select>
											</div>
										</div>
										<button class="search_form_button ml-auto">search</button>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- News -->

			<div class="news">
				<div class="container">
					<div class="row">

						<!-- News Posts -->
						<div class="col-lg-8" style="margin-top: 50px;display: flex;vertical-align: middle;">
							<div class="news_posts" style="margin-left: 20%;    text-align: center;">
								<div id="show_wallet_money" class="sidebar_title">
									Money in wallet
								</div>
								<div id="show_balance" class="sidebar_title" style="color: grey;">
									Your current balance is : 
								</div>
								<div style="display: inline-flex;">
									<div style="margin: 10px;">
										<br><input id="withdraw_amount" type="number" name="Withdraw" placeholder="Withdraw" style="height: 50px;text-align: center;outline: none;"><br><br>
										<button class="custom_button" onclick="App_current_page.withdrawl()">Draw Back</button>
									</div>
									<div style="margin: 10px;">
										<br><input id="deposit_amount" type="number" name="Deposit" placeholder="Deposit" style="height: 50px;text-align: center;outline: none;"><br><br>
										<button class="custom_button" onclick="App_current_page.deposit()">Deposit</button>
									</div>
									
								</div>
								
							</div>

							<!-- Pagination -->
						<!-- <div class="pagination">
							<ul>
								<li class="active"><a href="#">01.</a></li>
								<li><a href="#">02.</a></li>
								<li><a href="#">03.</a></li>
								<li><a href="#">04.</a></li>
							</ul>
						</div> -->
					</div>

					<!-- Sidebar -->
					<div class="col-lg-4" style="display: none;">
						<div class="sidebar">

							<!-- Latest Posts -->
							<div class="sidebar_latest">
								<div class="sidebar_title">Latest Transcation</div>
								<div id="Transcation_record_div" class="sidebar_latest_posts">

									<!-- Recent Post -->
									<div class="latest_post d-flex flex-row align-items-start justify-content-start">
										<div><div class="latest_post_image"><img src="images/trust_lend_logo.png" alt=""></div></div>
										<div class="latest_post_content">
											<div class="latest_post_date"><a href="#">Time</a></div>
											<div class="latest_post_title"><a href="#">+100</a></div>
											<div class="latest_post_author">From <a href="#">???</a></div>
										</div>
									</div>

									<!-- Recent Post -->
									<div class="latest_post d-flex flex-row align-items-start justify-content-start">
										<div><div class="latest_post_image"><img src="images/latest_2.jpg" alt=""></div></div>
										<div class="latest_post_content">
											<div class="latest_post_date"><a href="#">Time</a></div>
											<div class="latest_post_title"><a href="#">+100</a></div>
											<div class="latest_post_author">From <a href="#">???</a></div>
										</div>
									</div>

									<!-- Recent Post -->
									<div class="latest_post d-flex flex-row align-items-start justify-content-start">
										<div><div class="latest_post_image"><img src="images/latest_3.jpg" alt=""></div></div>
										<div class="latest_post_content">
											<div class="latest_post_date"><a href="#">Time</a></div>
											<div class="latest_post_title"><a href="#">+100</a></div>
											<div class="latest_post_author">From <a href="#">???</a></div>
										</div>
									</div>

									<!-- Recent Post -->
									<div class="latest_post d-flex flex-row align-items-start justify-content-start">
										<div><div class="latest_post_image"><img src="images/latest_4.jpg" alt=""></div></div>
										<div class="latest_post_content">
											<div class="latest_post_date"><a href="#">Time</a></div>
											<div class="latest_post_title"><a href="#">+100</a></div>
											<div class="latest_post_author">From <a href="#">???</a></div>
										</div>
									</div>

								</div>
							</div>

							<!-- Sidebar Search -->
							
						</div>
					</div>
				</div>
			</div>
			</div>
		</div>

		<script src="js/header.js"></script>

		<script src="js/jquery-3.2.1.min.js"></script>
		<script src="styles/bootstrap4/popper.js"></script>
		<script src="styles/bootstrap4/bootstrap.min.js"></script>
		<script src="plugins/greensock/TweenMax.min.js"></script>
		<script src="plugins/greensock/TimelineMax.min.js"></script>
		<script src="plugins/scrollmagic/ScrollMagic.min.js"></script>
		<script src="plugins/greensock/animation.gsap.min.js"></script>
		<script src="plugins/greensock/ScrollToPlugin.min.js"></script>
		<script src="plugins/OwlCarousel2-2.2.1/owl.carousel.js"></script>
		<script src="plugins/easing/easing.js"></script>
		<script src="plugins/parallax-js-master/parallax.min.js"></script>
		<script src="js/about.js"></script>

		<script src="js/web3.min.js"></script>
		<script src="js/truffle-contract.js"></script>
		<!-- <script src="js/app.js"></script> -->

		<script type="text/javascript">
			$('#header_tab_4').addClass("active");
			// Webpage Logic Explained:
			// 1. Initialize Web3 Provider to get access to the blockchain
			// 2. Use the Web3 Instance to access account, access blockchain information

			// Webpage Function Explained:
			// 1. Get Current User Address - web3.eth.getCoinbase
			// 3. Retrieve Lend list - 
			// 4. Show lend information - 

			var FLAG = 0;
			var loans_dict = new Object();
			var loans_info = {};
			var rate_type_convert = ["daily","monthly","annually"];
			var user_balance = 0;

			App_current_page = {

				web3Provider: null,
				contracts: {},
				account: '0x0',

				init: function() {
					console.log("#1. Initiating the Wallet page")
					return App_current_page.initWeb3();
				},

				initWeb3: function() {
					console.log("#2. Initiating Web3 Provider")

					if (typeof web3 !== 'undefined') {
						// If a web3 instance is already provided by Meta Mask.
						App_current_page.web3Provider = web3.currentProvider;
						web3 = new Web3(web3.currentProvider);

						// Metamask requires us to ask for access to the user accounts
						// only when user agrees the access, can we use those information
						// Metamask will remember the user's option, so that the confirmation box will pop-up only once for each application
						try {
							// Request account access if needed
							ethereum.enable();
						} catch (error) {
							// User denied account access...
							console.log(error);
			          	}
					} else {
						// Specify default instance if no web3 instance provided
						App_current_page.web3Provider = new Web3.providers.HttpProvider('http://localhost:7545');
						web3 = new Web3(App_current_page.web3Provider);
					}
					return App_current_page.initContract();
				},

				initContract: function() {
					console.log("#3. Initiating the contract");

					$.getJSON("Manager.json", function(manager) {
						// Instantiate a new truffle contract from the artifact
						App_current_page.contracts.Manager = TruffleContract(manager);
						// Connect provider to interact with contract
						App_current_page.contracts.Manager.setProvider(App_current_page.web3Provider);
						return App_current_page.render();
					});

					$.getJSON("UserProfile.json", function(profileManager) {
					  // Instantiate a new truffle contract from the artifact
					  App_current_page.contracts.ProfileManager = TruffleContract(profileManager);
					  // Connect provider to interact with contract
					  App_current_page.contracts.ProfileManager.setProvider(App_current_page.web3Provider);
					  return App_current_page.render();
					});
				},

				render: function() {
					var managerInstance;

				    // Load account data
				    web3.eth.getCoinbase(function(err, account) {
				    	if (err === null) {
				    		App_current_page.account = account;
				    		console.log("Wallet Page account is :", account);
				    		$('#header_user_address').html("User : "+account.substring(0,4)+` ... `+account.substring(account.length-5,account.length));
				    	}
				    });

				    App_current_page.contracts.Manager.deployed().then(function(instance) {
				    	managerInstance = instance;
				    	return managerInstance.getBalance({from: App_current_page.account});
				    }).then(function(balance){
				    	FLAG = 1;
				    	console.log("Totoal balance of the current user is : ",Number(balance));
				    	showBalance(Number(balance));
				    }).catch(function(error){
				    	console.warn(error);
				    });

				    App_current_page.contracts.ProfileManager.deployed().then(function(instance) {
				    	return instance.getUserName(App_current_page.account.toLowerCase(),{from: App_current_page.account});
				    }).then(function(name){
				    	console.log("have name: ", name);
				    	$('#header_user_address').html("User : "+name);
				    }).catch(function(error){
				    	console.warn(error);
				    });
				},

				withdrawl: function(){
					amount = $('#withdraw_amount').val();
					amount = amount*Math.pow(10,18)
					console.log("the money user want to withdraw is: ",amount/Math.pow(10,18)," ether");

					if(amount>user_balance){
						alert("withdraw amount should not exceed "+user_balance/Math.pow(10,18));
					}else if(amount<=0){
						alert("withdraw amount should be greater than 0");
					}else{
						App_current_page.contracts.Manager.deployed().then(function(instance){
							console.log("the withdraw_amount is : ",amount/Math.pow(10,18));
							return instance.withdrawl(amount,{from: App_current_page.account});
						}).then(function(result){
							$('#withdraw_amount').value = NULL;
							App_current_page.render();
						}).catch(function(err){
							console.error(err);
						});
					}
				  	// $('#withdraw_amount').placeholder = 0;
				  },

				  deposit: function(){
				  	amount = $('#deposit_amount').val();
					amount = amount*Math.pow(10,18)
					console.log("the money user want to deposit is: ",amount/Math.pow(10,18)," ether");

					if(1==0){
						alert("withdraw amount should not exceed "+user_balance/Math.pow(10,18));
					}else if(1==0){
						alert("withdraw amount should be greater than 0");
					}else{
						App_current_page.contracts.Manager.deployed().then(function(instance){
							console.log("the deposit_amount is : ",amount/Math.pow(10,18));
							return instance.deposit({from: App_current_page.account, value: amount});
						}).then(function(result){
							$('#withdraw_amount').value = NULL;
							App_current_page.render();
						}).catch(function(err){
							console.error(err);
						});
					}
				  },



				  postBorrow: function(){
				    // var amount = $('#postBorrow_amount').val();

				    var amount = $('#input_borrowAmount').val();
				    var rate_type_string = $('#input_rateType').val();
				    var rate_type = 0;
				    var interest_Rate = $('#input_interestRate').val();

				    if(rate_type_string=="daily"){
				    	rate_type=1;
				    }else if(rate_type_string=="monthly"){
				    	rate_type=2;
				    }else if(rate_type_string=="annually"){
				    	rate_type=3;
				    }

				    if(amount<=0){
				    	alert("Borrow amount should greater than 0");
				    }else if(rate_type != 1 && rate_type != 2 && rate_type != 3){
				    	alert("Please select a valid rate type");
				    }else if(interest_Rate<=0 || interest_Rate>=100){
				    	alert("Interest rate should within 0 to 100");
				    }else{
				    	App_current_page.contracts.Manager.deployed().then(function(instance){
				    		return instance.postBorrow(amount,rate_type,{from: App_current_page.account});
				    	}).then(function(result){
				    		App_current_page.render();
				    	}).catch(function(err){
				    		console.error(err);
				    	});
				    }
				},
		};

		function showBalance(balance){
			$('#show_balance').html("Your current balance is : "+balance/Math.pow(10,18));
			user_balance = balance;
		};

		function insertBorrowGrid (){
			$('#loans_need_lender').html("");
			console.log("loans_dict:", loans_dict);
			console.log("Creating a grid");
			for(var key in loans_dict){
				  	// console.log("now dict:", loans_dict[key]);
				  	if(loans_dict[key]["isLend"]==0){
				  		new_grid_html = `
				  		<div id="`+"loan_need_lender"+key+`"class="col-lg-3 col-md-6">
				  		<div class="realtor_outer">
				  		<div class="realtor">
				  		<div class="realtor_image"><img src="images/trust_lend_logo.png" alt=""></div>
				  		<div class="realtor_body">
				  		<div class="realtor_title">Amount: `+loans_dict[key]["amountRequest"]+`</div>
				  		<div class="realtor_subtitle">Rate Type: `+rate_type_convert[loans_dict[key]["rateType"]-1]+`</div>
				  		<div class="realtor_subtitle">Interest Rate: `+loans_dict[key]["interestRate"]+`%</div>
				  		</div>

				  		<div class="realtor_link" style="display:none;">
				  		<button class="search_form_button ml-auto" onclick='' style="width:50px;">Pay</button>
				  		</div>
				  		</div>
				  		<div class="realtor_link_background_container" style="display:none;">
				  		<div><div class="realtor_link_background"></div></div>
				  		</div>
				  		</div>
				  		</div>
				  		`;
				  		$('#loans_need_lender').append(new_grid_html);
				  	}else if(loans_dict[key]["isPayOff"]==0){
				  		new_grid_html = `
				  		<div id="`+"loan_need_lender"+key+`"class="col-lg-3 col-md-6">
				  		<div class="realtor_outer">
				  		<div class="realtor">
				  		<div class="realtor_image"><img src="images/trust_lend_logo.png" alt=""></div>
				  		<div class="realtor_body">
				  		<div class="realtor_title">Amount: `+loans_dict[key]["amountRequest"]+`</div>
				  		<div class="realtor_subtitle">Rate Type: `+rate_type_convert[loans_dict[key]["rateType"]-1]+`</div>
				  		<div class="realtor_subtitle">Interest Rate: `+loans_dict[key]["interestRate"]+`%</div>
				  		</div>

				  		<div class="realtor_link" style="display:none;">
				  		<button class="search_form_button ml-auto" onclick='' style="width:50px;">Pay</button>
				  		</div>
				  		</div>
				  		<div class="realtor_link_background_container" style="display:none;">
				  		<div><div class="realtor_link_background"></div></div>
				  		</div>
				  		</div>
				  		</div>
				  		`;
				  		$('#loans_need_lender').append(new_grid_html);
				  	}
				  }
		};

		$(function() {
			$(window).on('load',function() {
				App_current_page.init();
			});
		});

			</script>
	</body>
</html>